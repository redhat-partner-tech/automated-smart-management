---
- name: set hostname
  ansible.builtin.hostname:
    name: "{{ inventory_hostname | regex_replace('_','-')}}"

- block:
  - name: remove rhui client packages
    ansible.builtin.package:
      name: rh-amazon-rhui-client*
      state: removed

  - name: get current repos
    ansible.builtin.command:
      cmd: ls /etc/yum.repos.d/
    register: repos
    changed_when: False

  - name: remove existing rhui repos
    ansible.builtin.file:
      path: "/etc/yum.repos.d/{{ item }}"
      state: absent
    loop: "{{ repos.stdout_lines }}"

  - name: install katello package
    ansible.builtin.package:
      name: "https://{{ sat_url }}/pub/katello-ca-consumer-latest.noarch.rpm"
      state: present
      validate_certs: no
      disable_gpg_check: true
    when: sat_url is defined

  - name: define activation key
    ansible.builtin.set_fact:
      activation_key: "{{ 'RHEL' + ansible_distribution_major_version + '_' + env }}"

  - name: register system via subscription-manager
    community.general.redhat_subscription:
      state: present
      activationkey: "{{ activation_key }}"
      org_id: "{{ org_id | default('Default_Organization')}}"
    throttle: 1

  # No longer hard-coding rhsm_enabled_repos repositories list variable.
  # By default, rhsm_enabled_repos will default to an empty list.
  # List of repositories to be enabled, will need to be set out side of this role.
  # - name: include repos
  #   ansible.builtin.include_vars: "vars/{{ ansible_distribution + ansible_distribution_major_version }}.yml"

  - name: enable repos
    community.general.rhsm_repository:
      name: "{{ rhsm_enabled_repos }}"
      state: enabled
    when: rhsm_enabled_repos is iterable and rhsm_enabled_repos is not string

  when:
    - ansible_distribution == 'RedHat'

- block:
  - name: get current repos
    ansible.builtin.command:
      cmd: ls /etc/yum.repos.d/
    register: repos
    changed_when: False

  - name: install subscription-manager package
    ansible.builtin.package:
      name: subscription-manager
      state: present
      disable_gpg_check: true

  - name: install katello package
    ansible.builtin.package:
      name: "https://{{ sat_url }}/pub/katello-ca-consumer-latest.noarch.rpm"
      state: present
      validate_certs: no
      disable_gpg_check: true
    when: sat_url is defined

  - name: define activation key
    ansible.builtin.set_fact:
      activation_key: "{{ 'CentOS' + ansible_distribution_major_version + '_' + env }}"

  - name: register system via subscription-manager
    community.general.redhat_subscription:
      state: present
      activationkey: "{{ activation_key }}"
      org_id: "{{ org_id | default('Default_Organization')}}"
      pool: "{{ product_name_or_regex }}"
    throttle: 1

  - name: Create backup repos dir
    ansible.builtin.file:
      path: "/etc/yum.repos.centos"
      state: directory
      mode: 0755

  - name: Copy repo defs to backup dir
    ansible.builtin.copy:
      src: "/etc/yum.repos.d/{{ item }}"
      dest: "/etc/yum.repos.centos/{{ item }}"
      remote_src: yes
    loop: "{{ repos.stdout_lines }}"

  - name: remove pre-existing CentOS repos
    ansible.builtin.file:
      path: "/etc/yum.repos.d/{{ item }}"
      state: absent
    loop: "{{ repos.stdout_lines }}"

  when:
    - ansible_distribution == 'CentOS'
